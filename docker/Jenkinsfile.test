pipeline {
  agent any

  stages {

    stage('Clone repository') {
      // Missing Credentials can be added via UI
      // Look at the bottom of the box for a link called "Pipeline-Syntax"
      // If you don't have much Jenkins experience,
      // there you can generate pipelines with a few Dropdowns and Textboxes
      steps {
        git branch: 'cd_dev', poll: false, url: 'https://github.com/readium/readium-lcp-server'
      }
    }

    stage('Build') {
      steps {
        script {
          withCredentials([string(credentialsId: 'SLACK_TOKEN', variable: 'SLACK_TOKEN', domain: 'lcp')]) {
          app = docker.build("readium-lcp-server-build-test", """ \
              -f docker/Dockerfile \
              --progress=plain \
              --build-arg LOGGING_SLACK_TOKEN="$SLACK_TOKEN" \
              --build-arg LOGGING_SLACK_CHANNEL="C07KFNG59PF" \
              .
              """)
          }
        }
      }
    }

    stage('Test image') {
      steps {
        script {
          app.inside {
            sh 'echo "Tests passed"'
          }
        }
      }
    }

    stage('Push image') {
      steps {
        script {
          docker.withRegistry('http://registry-lcp.local:5000') {
            app.push("latest")
          }
        }
      }
    }

    stage('Remove image') {
      steps {
        script {
          sh "docker image rm -f ${app.imageName()}"
        }
      }
    }
  }
}
